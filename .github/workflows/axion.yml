name: AxionAOSP Android 16 | Poco M2 Pro (gram)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git curl repo python3 bc bison build-essential zip unzip \
          flex libncurses5 libncurses5-dev libssl-dev ccache \
          libgl1-mesa-dev libxml2-utils xsltproc fontconfig

    - name: Setup repo tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Init Axion AOSP source
      run: |
        mkdir axion
        cd axion
        repo init -u https://github.com/AxionAOSP/android.git -b sixteen --depth=1
        repo sync -c --force-sync --no-clone-bundle --no-tags -j$(nproc)

    - name: Clone device / vendor / kernel trees
      run: |
        cd axion
        git clone https://github.com/Devendiran3544/device_xiaomi_miatoll device/xiaomi/gram
        git clone https://github.com/Devendiran3544/vendor_xiaomi_miatoll vendor/xiaomi/gram
        git clone https://github.com/Devendiran3544/kernel_xiaomi_sm6250 kernel/xiaomi/gram

    - name: Build Axion AOSP
      run: |
        cd axion
        source build/envsetup.sh
        lunch axion_gram-userdebug
        mka bacon -j$(nproc)

    - name: Upload ROM zip
      uses: actions/upload-artifact@v4
      with:
        name: AxionAOSP-Android16-PocoM2Pro
        path: axion/out/target/product/gram/*.zip
